# WDM (Windows Driver Model)

## Зміст - in process
1. [Послідовність звернення ОС до підпрограми у драйвері (скорочено)](#r1)
2. [Розташування об'єктів пристрою та драйверів у WDM](#r2)
20. [Посилання](#references)
______


## <a name="r1">Послідовність звернення ОС до підпрограми у драйвері (скорочено)</a>

1. Користувач підключає пристрій та система завантажує виконуваний файл нашого драйвера в віртуальну пам'ять і викликає функцію **DriverEntry**. **DriverEntry** виконує кілька дій і повертається
2. Менеджер **Plug and Play** (**PnP Manager**) викликає нашу функцію **AddDevice**, яка також виконує кілька дій і повертається
3. **PnP Manager** відправляє нам кілька **IRP** (*Input/Output Request Packets*). Наша функція обробки диспетчеризації обробляє кожен **IRP** по черзі і повертається
4. Додаток відкриває дескриптор до нашого пристрою і система відправляє нам ще один **IRP**. Наша функція обробки диспетчеризації виконує деяку роботу і повертається
5. Додаток намагається прочитати деякі дані і тоді система відправляє нам **IRP**. Наша функція обробки диспетчеризації поміщає **IRP** в чергу і повертається
6. Попередня операція <u>вводу-виводу</u> завершується, посилаючи апаратне переривання, до якого наш драйвер підключений. Наша функція обробки переривання виконує деяку роботу, заплановує виклик **DPC** (Deffered Procedure Call - виклик відкладеної процедури) і повертається
7. Виконується наша функція **DPC**. Серед інших дій, вона видаляє **IRP**, яку ми поставили в чергу на кроці 5, і програмує апаратне забезпечення для зчитування даних. Після цього функція **DPC** повертається до системи
8. Проходить деякий час, протягом якого система робить багато інших коротких викликів до наших підпрограм
9. Зрештою, кінцевий користувач відключає наш пристрій. **PnP Manager** відправляє нам деякі **IRP**, які ми обробляємо і повертаємо. Операційна система викликає нашу функцію **DriverUnload**, яка, як правило, виконує невелику кількість роботи і повертається. Потім система видаляє код нашого драйвера з віртуальної пам'яті

## <a name="r2">Розташування об'єктів пристрою та драйверів у WDM</a>

**Function driver** - функціональний драйвер,або драйвер пристрою. Він відповідає за ініціювання операцій введення/виведення, обробку переривань, що виникають після завершення цих операцій, а також надання можливості кінцевому користувачеві здійснювати необхідний контроль над пристроєм

**Bus driver** - або драйвер шини, відповідає за управління з'єднанням між апаратним забезпеченням та комп'ютером. Наприклад, драйвер шини **Peripheral Component Interconnect** (**PCI**) - це програмна компонента, яка виявляє, що ваша карта підключена до слоту **PCI**. Це також програмне забезпечення, яке вмикає або вимикає потік електричного струму до слоту вашої карти  

Фільтр-драйвери зазвичай просто спостерігають за виконанням операцій введення/виведення функціональним драйвером. Частіше всього, постачальник програмного або апаратного забезпечення надає фільтр-драйвер для зміни поведінки наявного функціонального драйвера певним чином. 

**Upper filter** - драйвери бачать **IRP** (пакети протоколу вводу/виводу) перед *функціональним* драйвером і мають можливість надавати додаткові функції, про які функціональний драйвер не знає. Іноді верхній фільтр може здійснювати обхід для виправлення помилки або іншого недоліку в роботі функціонального драйвера або апаратного забезпечення. 

**Lower filter** - драйвери бачать **IRP**, які функціональний драйвер намагається надіслати до драйвера шини. (Нижній фільтр знаходиться нижче функціонального драйвера в стеку, але все ще вище драйвера шини.) У деяких випадках, наприклад, коли пристрій підключений до універсальної послідовної шини (**USB**), нижній фільтр може модифікувати потік операцій шини, які функціональний драйвер намагається виконати

![img1](https://github.com/sotnikea/Drivers_Learn/raw/main/WDM/images/layering_of_device_objects_and_drivers.png)

Де:
- PDO - physical device object. Драйвер шини використовує цей об'єкт для представлення з'єднання між пристроєм і шиною
- FDO - function device object. Функціональний драйвер використовує цей об’єкт для керування функціональністю пристрою
- FiDO - filter device object. Драйвер фільтра використовує цей об’єкт як місце для зберігання необхідної інформації про апаратне забезпечення та його дії фільтрації

## <a name="references">Посилання</a>
