## Зміст
1. [Концепция WDF драйверов](#r1)
    - [WDF архитектура](#r1_1)
    - [Минимальные требования к драйверу](#r1_2)
2. [Билд драйвера](#r2) 
    - [Установка WDK](#r2_1)
    - [Windows-driver-samples](#r2_2)
    - [Настройка свойств проекта](#r2_3)
    - [Spectre-mitigated libraries](#r2_4)
3. [Настройка виртуальной машины для дебага драйвера](#r3)
    - [Using com-port](#r3_1) 
        - [Настройка символов на хосте](#r3_1_1) 
        - [Настройка VMware](#r3_1_2) 
        - [Настройка целевого компьютера](#r3_1_3) 
        - [Настройка WinDbg на хост компьютере](#r3_1_4) 
        - [Настройка немедленного запуска отладки](#r3_1_5) 
    - [Using network](#r3_2) 
        - [Setting Up KDNET Keys](#r3_2_1) 
        - [Configure kernel–mode debugging](#r3_2_2) 
        - [Запуск WinDbg Network debugging](#r3_2_3) 
4. [Установка тестового сертификата и драйвера](#r4)
5. [Дебаг драйвера](#r5)
    - [Установка брейкпоинта](#r5_1)
    - [Дебаг добавления драйвер](#r5_2)
    - [Дебаг запуска драйвера](#r5_3)
    - [Дебаг инициализации очереди](#r5_4)
    - [Дебаг запросов тестового приложения к драйверу](#r5_5)

______


## <a name="r1">Концепция WDF драйверов</a>
**WDF** – Windows Driver Framework.   
WDF драйверы состоят из
- DriverEntry подпрограммы
- Набор функций обратного вызова событий драйвера (callback функции, вызывающие методы объекта)    
**WDK** – Windows Driver Kit содержит примеры WDF драйверов, которые демонстрируют как имплементировать колбек функции.

### <a name="r1_1">WDF архитектура</a>
- *Object methods* - это функции, которые драйвер может вызвать для выполнения операций или заполнения свойств объекта
- *Object event callback functions* - это функции, предоставляемые драйвером. Каждая такая функция связана с событием, которое может произойти с объектом. Собственно произошло событие - выполнилась привязанная к нему функция. Обычно функции, заполняющие колбек функции называют следующим образом EvtObjectEvent
- *Object properties* - это значения, хранящиеся в объекте, и к которым драйвер имеет доступ. Может их читать или записывать.
- *Object handles* - драйвер не обращается к объекту, а получает дескриптор, по которому может вызвать нужные методы.

### <a name="r1_2">Минимальные требования к драйверу</a>
- Точка входа в драйвер **DriverEntry** (запустится при запуске драйвера). Подпрограмма **DriverEntry** должна вызвать функцию  [WdfDriverCreate](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdfdriver/nf-wdfdriver-wdfdrivercreate). В этой функции так же регистрируються колбек функции
- Набор **callback** функций. Драйвер изначально предоставляет ряд функций, которые срабатывают при выполнении определенного условия (подключения нового устройства, получение сообщения и т.д.). Колбек функции это функции, которые будут запускаться для выполнения каждого конкретного условия
- Если обрабатываются **I/O операции**, то должен быть реквест хендлер. Для каждого девайса создается отдельная I/O очередь, после чего вызывается [WdfIoQueueCreate](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdfio/nf-wdfio-wdfioqueuecreate) чтобы добавить полученную операцию в очередь.

## <a name="r2">Билд драйвера</a>
### <a name="r2_1">Установка WDK</a>
Перед билдом драйвера необходимо установить подходящую версию **WDK** (*Window Driver Kit*). На самом деле **WDK** поставляется в составе **VS** (*Visual Studio*) и при использовании последней её версии каких-либо дополнительных действий выполнять не нужно (драйвер будет работать на всех ОС начиная с Windows7). Но в случае использования более ранних версий студии необходимо убедиться, что её достаточно для билда. Иными словами VS2017 недостаточно для билда драйвера, который будет запускаться на Windows10.
Для выбора минимально необходимой версии VS выполняем следующую последовательность действий:
1. Узнаем версию операционной системы, на которой планируем билдить и устанавливать драйвер. Для этого нажимаем **Start - Settings - System - About**. В группе "**Windows Specification**" находим "**Version**"
![img1](https://github.com/sotnikea/Drivers_Learn/raw/main/windbg_dbg/images/img1.png)

### <a name="r2_2">Windows-driver-samples</a>
### <a name="r2_3">Настройка свойств проекта</a>
### <a name="r2_4">Spectre-mitigated libraries</a>
## <a name="r3">Настройка виртуальной машины для дебага драйвера</a>
### <a name="r3_1">Using com-port</a>
#### <a name="r3_1_1">Настройка символов на хосте</a>
#### <a name="r3_1_2">Настройка VMware</a>
#### <a name="r3_1_3">Настройка целевого компьютера</a>
#### <a name="r3_1_4">Настройка WinDbg на хост компьютере</a>
#### <a name="r3_1_5">Настройка немедленного запуска отладки</a>
### <a name="r3_2">Using network</a>
#### <a name="r3_2_1">Setting Up KDNET Keys</a>
#### <a name="r3_2_2">Configure kernel–mode debugging</a>
#### <a name="r3_2_3">Запуск WinDbg Network debugging</a>
## <a name="r4">Установка тестового сертификата и драйвера</a>
## <a name="r5">Дебаг драйвера</a>
### <a name="r5_1">Установка брейкпоинта</a>
### <a name="r5_2">Дебаг добавления драйвер</a>
### <a name="r5_3">Дебаг запуска драйвера</a>
### <a name="r5_4">Дебаг инициализации очереди</a>
### <a name="r5_5">Дебаг запросов тестового приложения к драйверу</a>